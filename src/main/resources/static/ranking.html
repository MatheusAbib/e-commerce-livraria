<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Livros Online</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/ranking.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a6fa5'><path d='M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z'/></svg>">
</head>
<body>
  <div id="header-container"></div>

<div class="container">
<div class="ranking-header">
  <h1 class="ranking-title">
    <i class="fas fa-trophy"></i> Ranking de Clientes
  </h1>
  <p class="ranking-description">
    Descubra quem são os clientes mais engajados da nossa livraria. 
    O ranking é atualizado automaticamente com base no valor total de compras.
  </p>
  <div class="ranking-badge">
    <i class="fas fa-sync-alt"></i> Atualizado em tempo real
  </div>
</div>

  <!-- Campo de Busca -->
  <div class="campo-busca">
    <label for="busca-nome">
      <i class="fas fa-search"></i> Buscar cliente por nome
    </label>
    <input type="text" id="busca-nome" placeholder="Digite o nome do cliente...">
    <div id="mensagem-carregando">
      <i class="fas fa-spinner fa-spin"></i> Carregando resultados...
    </div>
  </div>

  <!-- Conteúdo do Ranking -->
  <div id="ranking-content">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Carregando ranking...</p>
    </div>
  </div>
</div>
<script>
  fetch('header.html')
    .then(response => response.text())
    .then(data => {
      const container = document.getElementById('header-container');
      container.innerHTML = data;

      const scripts = container.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
      });

      const clienteLogado = JSON.parse(localStorage.getItem('clienteLogado'));
      const nomeSpan = document.getElementById('nome-cliente');
      if (nomeSpan && clienteLogado) {
        nomeSpan.textContent = clienteLogado.nome;
      }

      const idsRestritos = [
        'link-usuarios',
        'link-log',
        'link-lucros',
        'link-livros',
        'link-pedidosADMIN'
      ];
      if (!clienteLogado || clienteLogado.perfil !== 'ADMIN') {
        idsRestritos.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
      }

      const linkStatusCliente = container.querySelector('a[href="pedidos.html"]');
      if (!clienteLogado || clienteLogado.perfil === 'ADMIN') {
        if (linkStatusCliente) linkStatusCliente.style.display = 'none';
      }
    });

  let rankingOriginal = []; // armazena a lista original
  let timeoutBusca;

  document.addEventListener('DOMContentLoaded', () => {
    carregarRanking();

    document.getElementById('busca-nome').addEventListener('input', () => {
      clearTimeout(timeoutBusca);
      document.getElementById('mensagem-carregando').style.display = 'block';

      timeoutBusca = setTimeout(() => {
        const termo = document.getElementById('busca-nome').value.toLowerCase();

        const filtrados = rankingOriginal.filter(cliente =>
          cliente.nome.toLowerCase().includes(termo)
        );

        exibirRanking(filtrados);
        document.getElementById('mensagem-carregando').style.display = 'none';
      }, 1000);
    });
  });

  async function carregarRanking() {
    try {
      const response = await fetch('/api/clientes/ranking');
      if (!response.ok) throw new Error('Erro ao carregar ranking');

      const ranking = await response.json();
      rankingOriginal = ranking; // salvar para buscas futuras
      exibirRanking(ranking);
    } catch (error) {
      console.error('Erro:', error);
      document.getElementById('ranking-content').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Não foi possível carregar o ranking de clientes.</p>
          <p>${error.message}</p>
        </div>
      `;
    }
  }

  function exibirRanking(ranking) {
    const container = document.getElementById('ranking-content');

    if (!ranking || ranking.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-trophy"></i>
          <p>Nenhum dado de ranking disponível no momento.</p>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <table class="ranking-table">
        <thead>
          <tr>
            <th>Posição</th>
            <th>Cliente</th>
            <th class="purchase-count">Pedidos</th>
            <th class="purchase-value">Valor Total</th>
          </tr>
        </thead>
        <tbody>
          ${ranking.map((cliente, index) => {
            const positionClass = index === 0 ? 'position-1' : 
                                index === 1 ? 'position-2' : 
                                index === 2 ? 'position-3' : '';
            const medalIcon = index === 0 ? '<i class="fas fa-trophy medal-icon"></i>' : 
                            index === 1 ? '<i class="fas fa-medal medal-icon"></i>' : 
                            index === 2 ? '<i class="fas fa-medal medal-icon"></i>' : '';
            
            return `
              <tr>
                <td class="ranking-position ${positionClass}">
                  ${medalIcon}${index + 1}º
                </td>
                <td>
                  <div class="user-info">
                    <div class="user-avatar">
                      ${cliente.nome.charAt(0).toUpperCase()}
                    </div>
                    <div>
                      <div class="user-name">${cliente.nome}</div>
                      <div class="user-email">${cliente.email}</div>
                    </div>
                  </div>
                </td>
                <td class="purchase-count">${cliente.quantidadePedidos || 0}</td>
                <td class="purchase-value">R$ ${(cliente.valorTotalGasto || 0).toFixed(2)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }
</script>

</body>
</html>